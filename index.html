<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrueChats Pro Live</title>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --whatsapp-green: #075e54; --bg-gray: #e5ddd5; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', sans-serif; }
        body { background: #d1d7db; height: 100vh; display: flex; justify-content: center; }
        #app { display: flex; width: 100%; max-width: 1200px; height: 100%; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        .sidebar { width: 30%; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .chat-area { width: 70%; display: flex; flex-direction: column; background: var(--bg-gray); }
        
        .header { background: var(--whatsapp-green); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 70%; font-size: 14px; }
        .sent { align-self: flex-end; background: #dcf8c6; }
        .recv { align-self: flex-start; background: #fff; }

        .input-bar { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        button { background: var(--whatsapp-green); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }

        /* Call Overlay */
        #call-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 100; }
    </style>
</head>
<body>
    <div id="app">
        <div class="sidebar">
            <div class="header">TrueChats</div>
            <div style="padding: 10px;">
                <input type="text" id="my-id" placeholder="Enter your Name/Phone">
                <button onclick="login()" style="width: 100%; margin-top: 5px;">Login</button>
            </div>
            <div id="contact-list" style="overflow-y: auto; flex: 1;"></div>
        </div>
        <div class="chat-area">
            <div class="header">
                <span id="chat-with">Select a contact</span>
                <button id="call-btn" onclick="startCall()" style="display:none;">ðŸ“ž Call</button>
            </div>
            <div id="messages"></div>
            <div class="input-bar">
                <input type="text" id="msg-input" placeholder="Type a message...">
                <button onclick="send()">Send</button>
            </div>
        </div>
    </div>

    <div id="call-screen">
        <h2 id="call-status">Calling...</h2>
        <audio id="remote-audio" autoplay></audio>
        <button onclick="endCall()" style="background: red; margin-top: 20px;">End Call</button>
    </div>

    <script>
        let peer, myId, targetId, conn;
        
        function login() {
            myId = document.getElementById('my-id').value;
            if(!myId) return alert("Enter ID");
            
            // PeerJS Setup for Voice
            peer = new Peer(myId);
            peer.on('open', (id) => {
                alert("Logged in as: " + id);
                document.getElementById('contact-list').innerHTML = `<div onclick="setTarget('TestUser')" style="padding:15px; border-bottom:1px solid #eee; cursor:pointer;">TestUser (Click to chat)</div>`;
            });

            // Handling Incoming Calls
            peer.on('call', (call) => {
                if(confirm("Incoming Voice Call from " + call.peer)) {
                    navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                        call.answer(stream);
                        showCallScreen();
                        call.on('stream', remoteStream => {
                            document.getElementById('remote-audio').srcObject = remoteStream;
                        });
                    });
                }
            });
        }

        function setTarget(id) {
            targetId = id;
            document.getElementById('chat-with').innerText = "Chatting with: " + id;
            document.getElementById('call-btn').style.display = "block";
        }

        function send() {
            const text = document.getElementById('msg-input').value;
            // Database and Pusher trigger logic ikkada untundi
            appendMsg(text, 'sent');
            document.getElementById('msg-input').value = "";
        }

        function appendMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            document.getElementById('messages').appendChild(div);
        }

        function startCall() {
            navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                const call = peer.call(targetId, stream);
                showCallScreen();
                call.on('stream', remoteStream => {
                    document.getElementById('remote-audio').srcObject = remoteStream;
                });
            });
        }

        function showCallScreen() { document.getElementById('call-screen').style.display = 'flex'; }
        function endCall() { location.reload(); }
    </script>
</body>
</html>
